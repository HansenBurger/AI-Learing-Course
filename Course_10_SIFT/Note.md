# 尺度不变特征变换(SIFT)

图像拼接技术

1. 分别提取待凭借图片的特征点
2. 拟合透视矩阵得到不同场景下的同一物体

## 一、SIFT简介

提取图像的局部特征, **在尺度空间寻找极值点, 提取位置尺度方向信息**

(比一般图像只看位置和灰度特征不同)

应用: 物体辨别, 机器人地图感知和导航, 手势识别, 影像追踪

特点:

1. 旋转, 尺度缩放, 亮度变化保持不变性(对视角变化, 噪声也存在稳定性)
2. 独特性, 信息量丰富, 适用于在海量特征数据中进行快速准确匹配
3. 多量性, 即使少数几个物体也可以产生大量sift特征向量
4. 可扩展性, 可以很方便的与其他形式的特征向量进行联合

图像拼接的主要流程:

![SIFT_pic_combine](https://pic.imgdb.cn/item/637d770216f2c2beb1698da8.png)

sift有专利, opencv > 3.4.3中不再提供

解决方案:

```zsh
pip install opencv-python==3.4.2.16
pip install opencv-contrib-python==3.4.2.16
```

## 二、SIFT提取和匹配步骤

1. 生成**高斯差分金字塔**(DOG金字塔), **尺度空间构建**
2. 空间极值点检测
3. 稳定关键点的精确定位
4. 稳定关键点方向信息分配
5. 关键点描述
6. 特征点匹配

## 三、步骤1-构建DOG金字塔

### 3.1 尺度空间

尺度的大小, 决定了观察的仔细程度，通过改变图片分辨率模拟人眼。

尺度空间: 在图像领域模拟人眼观察物体的概念与方法(观察局部, 则观察局部特征; 观察整体, 则大尺度观察去除细节)

### 3.2 图像金字塔

用多种分辨率来解释图像的结构，通过原始图像进行多尺度像素排列(传统金字塔: 顶部只包含一个像素)

图像金字塔示意图:

![img_blur_matching](https://miro.medium.com/max/1400/1*cJF_YgCOMjhZDJQinfojTA.png)

步骤:

1. **降噪**，利用滤波器平滑图像(高斯滤波)
2. **采样**，对平滑图像进行抽样(各种插值方法)

两种采样方式:

1. 上采样(分辨率逐级升高)
2. 下采样(分辨率逐级下降)

### 3.3 高斯金字塔

概念: 通过高斯滤波检测出轮廓的金字塔(**主轮廓**作一个特征向量, 实现边缘角点检测**不同分辨率上的关键点**提取)。

特点: 存在很多组(Octave)金字塔, 且每组(个)金子塔有很多层(Interval)

构建过程:

1. 先将原图像扩大一倍(实验科学)作为1组1层， 再将1组1层高斯卷积(滤波)作为1组金字塔的2层
2. 将 $\sigma$ (SIFT中一般为6)乘以 $k$ (比例系数), 得到平滑因子 $\sigma=k\times \sigma$ 用来平滑第1组的第2层, 生成结果作为第3层
3. 重复步骤2，得到L层图像, 每层图像**尺寸一样**(需要padding), **平滑系数不同**: $0, \sigma, k\sigma, k^2\sigma, ... , k^{L-2}\sigma$
4. 第1组倒数第3层尺寸减半(实验科学), 作为2组第1层。**尺寸第2组是第1组图像的一半**，同组间尺寸一致，相邻组尺寸为令一组的一半
5. 重复步骤2-4，得到一共O组, 每组L层, 共计L*O个图像, 构成高斯金字塔

最终高斯金字塔示意图

![pyramid_display](https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fs41598-020-80189-1/MediaObjects/41598_2020_80189_Fig1_HTML.png)

其中每一组的层的顺序是**由下到上**，而步骤4中的**倒数第3层实际为从上往下第3层**，高斯平滑过程依赖于高斯函数:

$$
\begin{equation}
G(x,y) = \frac{1}{2\pi\sigma ^2}exp(-\frac{(x-x_0)^2+(y-y_0)^2}{2\sigma^2})
\end{equation}
$$

> 1. 同一组内, 不同层图像尺寸一样, 后一层高斯平滑因子为前一层的k倍
> 2. 不同组间, 后一组的第一个图像是前一组倒数第三个图像的二分之一采样, 图像大小是前一组的一半

### 3.4 尺度空间

给定一组O(组数)L(层数)，就能确定高斯金字塔中的一副图像，即尺度空间，其中坐标为 $(O,L)$

尺度空间最主要的价值就是**使原始图像保存最多的细节特征，并通过高斯滤波模拟大尺度下特征表示**

而尺度空间图像的计算可以通过Eq.2 高斯函数和Eq.3 卷积运算表示:

$$
\begin{equation}
G(x_i,y_i,\sigma)=\frac{1}{2\pi\sigma^2}exp(-\frac{(x-x_i)^2+(y-y_i)^2}{2\sigma^2})
\end{equation}
$$

$$
\begin{equation}
L(x, y, \sigma)=G(x,y,\sigma)\cdot I(x,y)
\end{equation}
$$

### 3.5 DOG金字塔

差分金子塔: 第 $o$ 组的第 $l$ 层的图像是由高斯金字塔的第第 $o$ 组的第 $l+1$ 层和 $o$ 组的第 $l$ 层做差得到

差分金字塔实际计算可以参考:

![pyramid_differ](https://i.stack.imgur.com/7r8aH.png)

不同尺度下不同轮廓信息, 差分来提取特征，做差结果可以参考:

![pyramid_differ_img](https://d3i71xaburhd42.cloudfront.net/a245dac7c7b4eab0dc865146b4e7241eaf201690/2-Figure2-1.png)

> 由DOG金字塔最终得到尺度空间

## 四、步骤2-尺度空间极值检测

特征点是由DOG的空间局部极值点组成的(需要和它所有相邻点进行比较, 看是否比相邻点更大或者更小),即检测**每个像素领域的26个点**(上下层18，当前层8)是否为**极值点**，比较范围可以参考下图:

![extreme_value_detection](https://cdn.analyticsvidhya.com/wp-content/uploads/2019/09/Screenshot-from-2019-09-25-16-50-01.png)

> **注意**: 局部极值点是在同一个组中进行的, 某一个组的第一个和最后一个图层不存在前一张和后一张, **利用高斯模糊多出三张凑数**, DOG中多两张(多模糊的点不需要计算极值)

## 五、高斯金字塔参数(k, L, O)

首先 $k$，$L$，的设置都依赖于参数 $s$，即每组图像中检测尺度极值点中**尺度的个数**，实际计算中通常在3到5之间，又有 $k$ 和 $s$ 的关系，可以得到公式:

$$
\begin{equation}
k = 2 ^{\frac{1}{s}}
\end{equation}
$$

而对于需要提取极值点的 $s$ 层尺度，需要 $s+2$ 层的DOG金字塔，那根据高斯金字塔和DOG金字塔间的关系，可以得到每组的层数公式:

$$
\begin{equation}
L = L_{DOG} + 1 = (s + 2) + 1 = s+3
\end{equation}
$$

又因为每增加一组尺寸减半，所以组 $O$ 取决于金字塔顶端的组的**尺寸的对数**，就能推导到需要的组数 $O$，即:

$$
\begin{equation}
O = log_2\{min[M,N]\} - t, t\in[0, log_2\{min(M,N)\}]
\end{equation}
$$

其中 $t$ 表示最后一组中每层的尺寸的对数结果。

> s的意思是将来我们在差分金字塔中求极值点, 要求s层点(一层一个极值点)

## 六、步骤3-稳定关键点的精确定位(优化项)

对步骤2中得到的极值点进一步的筛选，**阈值方法**，可以用单阈值判断，此步骤为优化项。

可以使用opencv中的**contrastThreshold**函数。

## 七、步骤4-稳定关键点方向信息分配

意义: 不同尺度提取关键点**保证了尺度不变性**，而给关键点分配方向则保证了**旋转不变性**

方法: 获取关键点所在尺度空间的领域, 计算该区域的梯度和方向, 根据计算得到的结果创建方向直方图，实现方法可以参考下图:

![edge_orient](https://pic4.zhimg.com/80/v2-1cbda71b891cbf8aadaffd7920834727_720w.webp)

得到两个方向

1. 主方向: 峰值
2. 辅助方向: 高于主方向80%的方向(论文中分为8种，夹角45)

### 八、步骤5-关键点描述

每个关键点都有位置、尺度和方向(梯度方向)三个信息，如果根据领域划分为2\*2的区域，那么每个特征就有2\*2\*8(方向)的向量, 论文中使用 4\*4效果如下:

![edge_des](https://pic3.zhimg.com/80/v2-3d6bc620eb6366461bd9f799924edf1a_720w.webp)

具体的描述过程可以参考[SIFT详解](https://zhuanlan.zhihu.com/p/261697473)。

### 九、特征点匹配

1. 计算两组特征点128维的关键点的欧式距离
2. 欧式距离越小, 相似度越高, 欧式距离小于阈值, 可以判断维匹配成功
3. 特征匹配的方法很多
